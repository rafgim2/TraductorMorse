<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Morse Decoder</title>
<style>
  body{margin:0;background:#000;overflow:hidden}
  video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover}
  canvas{position:fixed;inset:0}
  #out{
    position:fixed;left:10px;right:10px;bottom:10px;
    padding:10px 12px;
    border:1px solid rgba(0,255,120,.8);
    border-radius:12px;
    background:rgba(0,0,0,.6);
    color:#7CFF9D;
    font:20px/1.3 system-ui;
  }
</style>
</head>
<body>

<video id="v" autoplay playsinline muted></video>
<canvas id="c"></canvas>
<div id="out"></div>

<script>
(() => {

const UNIT = 250;              // EXACTO a tu emisor
const ROI_SIZE = 32;           // ← CUADRADO REAL, PEQUEÑO

const MORSE = {
".-":"A","-...":"B","-.-.":"C","-..":"D",".":"E","..-.":"F",
"--.":"G","....":"H","..":"I",".---":"J","-.-":"K",".-..":"L",
"--":"M","-.":"N","---":"O",".--.":"P","--.-":"Q",".-.":"R",
"...":"S","-":"T","..-":"U","...-":"V",".--":"W","-..-":"X",
"-.--":"Y","--..":"Z",
"-----":"0",".----":"1","..---":"2","...--":"3","....-":"4",
".....":"5","-....":"6","--...":"7","---..":"8","----.":"9"
};

const v = document.getElementById("v");
const c = document.getElementById("c");
const ctx = c.getContext("2d",{willReadFrequently:true});
const out = document.getElementById("out");

let roi = { x: 40, y: 40 };    // ← EN PIXELES
let dragging=false, dx=0, dy=0;

function resize(){
  c.width  = innerWidth  * devicePixelRatio;
  c.height = innerHeight * devicePixelRatio;
}
addEventListener("resize", resize);
resize();

/* ===== DRAG REAL ===== */
c.addEventListener("pointerdown", e=>{
  const x=e.clientX*devicePixelRatio;
  const y=e.clientY*devicePixelRatio;
  if(x>=roi.x && x<=roi.x+ROI_SIZE &&
     y>=roi.y && y<=roi.y+ROI_SIZE){
    dragging=true;
    dx=x-roi.x; dy=y-roi.y;
    c.setPointerCapture(e.pointerId);
  }
});
c.addEventListener("pointermove", e=>{
  if(!dragging) return;
  roi.x=e.clientX*devicePixelRatio-dx;
  roi.y=e.clientY*devicePixelRatio-dy;
});
c.addEventListener("pointerup", ()=>dragging=false);
c.addEventListener("pointercancel", ()=>dragging=false);

/* ===== LUMINANCIA ===== */
function luminance(){
  ctx.drawImage(v,0,0,c.width,c.height);
  const d=ctx.getImageData(roi.x,roi.y,ROI_SIZE,ROI_SIZE).data;
  let s=0;
  for(let i=0;i<d.length;i+=16)
    s+=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2];
  return (s/(d.length/16))/255;
}

/* ===== DECODER ===== */
let base=0,smooth=0,lastOn=false,lastT=performance.now();
let cur="", text="";

function flush(){
  if(cur){ text+=MORSE[cur]||"�"; out.textContent=text; cur=""; }
}

function loop(){
  const l=luminance();
  base+=0.02*(l-base);
  smooth+=0.25*(l-smooth);

  const on = lastOn ? smooth>base+0.03 : smooth>base+0.05;
  const now=performance.now();

  if(on!==lastOn){
    const dt=now-lastT;
    lastT=now;
    if(lastOn && !on)
      cur+=dt<2*UNIT?".":"-";
    if(!lastOn && on && dt>=3*UNIT) flush();
    if(!lastOn && on && dt>=7*UNIT) text+=" ";
    lastOn=on;
  }

  ctx.clearRect(0,0,c.width,c.height);
  ctx.strokeStyle="rgba(0,255,120,.9)";
  ctx.lineWidth=3*devicePixelRatio;
  ctx.strokeRect(roi.x,roi.y,ROI_SIZE,ROI_SIZE);

  requestAnimationFrame(loop);
}

/* ===== START ===== */
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{
  v.srcObject=s;
  v.onloadedmetadata=()=>{v.play();loop();}
});

})();
</script>
</body>
</html>
