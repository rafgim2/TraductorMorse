<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Morse Decoder (final definitivo)</title>
<style>
  body{margin:0;background:#000;overflow:hidden}
  video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover}
  canvas{position:fixed;inset:0;touch-action:none}
  #out{
    position:fixed;left:12px;right:12px;bottom:12px;
    padding:10px 12px;
    border:1px solid rgba(0,255,120,.8);
    border-radius:14px;
    background:rgba(0,0,0,.6);
    color:#7CFF9D;
    font:20px/1.3 system-ui;
    white-space:pre-wrap;
  }
</style>
</head>
<body>

<video id="v" autoplay playsinline muted></video>
<canvas id="ui"></canvas>
<div id="out"></div>

<script>
(() => {

  /* ===== CONFIG ===== */
  const ROI = 24;
  const PATCH = 9;
  const IGNORE_LETTERS = 3; // ← preámbulo EEE

  const MORSE = {
    ".-":"A","-...":"B","-.-.":"C","-..":"D",".":"E","..-.":"F",
    "--.":"G","....":"H","..":"I",".---":"J","-.-":"K",".-..":"L",
    "--":"M","-.":"N","---":"O",".--.":"P","--.-":"Q",".-.":"R",
    "...":"S","-":"T","..-":"U","...-":"V",".--":"W","-..-":"X",
    "-.--":"Y","--..":"Z",
    "-----":"0",".----":"1","..---":"2","...--":"3","....-":"4",
    ".....":"5","-....":"6","--...":"7","---..":"8","----.":"9"
  };

  const v = document.getElementById("v");
  const ui = document.getElementById("ui");
  const ctxU = ui.getContext("2d");
  const out = document.getElementById("out");

  const cv = document.createElement("canvas");
  const ctxV = cv.getContext("2d",{willReadFrequently:true});

  function resize(){
    ui.width = cv.width = innerWidth;
    ui.height = cv.height = innerHeight;
  }
  addEventListener("resize", resize);
  resize();

  /* ===== ROI arrastrable ===== */
  let roi={x:80,y:80}, dragging=false, dx=0, dy=0;
  ui.addEventListener("pointerdown",e=>{
    if(e.clientX>=roi.x&&e.clientX<=roi.x+ROI &&
       e.clientY>=roi.y&&e.clientY<=roi.y+ROI){
      dragging=true; dx=e.clientX-roi.x; dy=e.clientY-roi.y;
      ui.setPointerCapture(e.pointerId);
    }
  });
  ui.addEventListener("pointermove",e=>{
    if(dragging){ roi.x=e.clientX-dx; roi.y=e.clientY-dy; }
  });
  ui.addEventListener("pointerup",()=>dragging=false);
  ui.addEventListener("pointercancel",()=>dragging=false);

  function drawCover(){
    const W=cv.width,H=cv.height;
    const vw=v.videoWidth,vh=v.videoHeight;
    if(!vw||!vh) return false;
    const s=Math.max(W/vw,H/vh);
    ctxV.drawImage(v,(W-vw*s)/2,(H-vh*s)/2,vw*s,vh*s);
    return true;
  }

  function readLum(){
    if(!drawCover()) return null;
    const cx=roi.x+ROI/2, cy=roi.y+ROI/2, h=PATCH>>1;
    const data=ctxV.getImageData(cx-h,cy-h,PATCH,PATCH).data;
    let sum=0;
    for(let i=0;i<data.length;i+=4)
      sum+=0.2126*data[i]+0.7152*data[i+1]+0.0722*data[i+2];
    return sum/(data.length/4);
  }

  /* ===== DECODER POR FRAMES ===== */
  let offLevel=null,onLevel=null,stableOn=false;
  let onF=0,offF=0,current="",text="";
  let started=false,letterClosed=false;
  let decodedCount=0;

  const dots=[];
  const dotUnit=()=>dots.length>=5?[...dots].sort((a,b)=>a-b)[dots.length>>1]:null;

  function flush(){
    if(!current) return;
    decodedCount++;
    if(decodedCount > IGNORE_LETTERS){
      text+=MORSE[current]||"�";
      out.textContent=text;
    }
    current="";
  }
  function space(){
    if(decodedCount>IGNORE_LETTERS && !text.endsWith(" ")){
      text+=" "; out.textContent=text;
    }
  }

  function loop(){
    const lum=readLum(); if(lum==null) return;
    if(offLevel==null){ offLevel=onLevel=lum; }

    const thr=(offLevel+onLevel)/2;
    const on = stableOn ? lum>thr-8 : lum>thr+8;

    if(on){ onF++; onLevel+=0.05*(lum-onLevel); }
    else{ offF++; offLevel+=0.05*(lum-offLevel); }

    if(on!==stableOn){
      const u=dotUnit();
      if(stableOn){
        if(!started && onF>=2) started=true;
        if(onF<=12) dots.push(onF);
        if(started&&u) current+=(onF<2*u?".":"-");
        onF=0; letterClosed=false;
      }else if(started&&u){
        if(offF>=6*u){ flush(); space(); letterClosed=true; }
        else if(offF>=1.3*u){ flush(); letterClosed=true; }
        offF=0;
      }
      stableOn=on;
    }

    const u=dotUnit();
    if(started&&!stableOn&&u){
      if(current&&offF>=1.8*u&&!letterClosed){ flush(); letterClosed=true; }
      if(offF>=6*u) space();
    }

    ctxU.clearRect(0,0,ui.width,ui.height);
    ctxU.strokeStyle="rgba(0,255,120,.9)";
    ctxU.strokeRect(roi.x,roi.y,ROI,ROI);
  }

  function start(){
    if("requestVideoFrameCallback"in HTMLVideoElement.prototype){
      const step=()=>{loop();v.requestVideoFrameCallback(step);};
      v.requestVideoFrameCallback(step);
    }else requestAnimationFrame(function step(){loop();requestAnimationFrame(step);});
  }

  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false})
    .then(s=>{v.srcObject=s;v.onloadedmetadata=()=>{v.play();start();};});

})();
</script>
</body>
</html>
