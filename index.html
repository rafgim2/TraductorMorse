<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Morse Decoder</title>

<style>
  body{
    margin:0;
    background:#000;
    overflow:hidden;
  }
  video{
    position:fixed;
    inset:0;
    width:100vw;
    height:100vh;
    object-fit:cover;
  }
  canvas{
    position:fixed;
    inset:0;
  }
  #out{
    position:fixed;
    left:12px;
    right:12px;
    bottom:12px;
    padding:10px 12px;
    border:1px solid rgba(0,255,120,.8);
    border-radius:14px;
    background:rgba(0,0,0,.6);
    color:#7CFF9D;
    font:20px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    white-space:pre-wrap;
  }
</style>
</head>

<body>

<video id="video" autoplay playsinline muted></video>

<!-- Canvas para leer vídeo -->
<canvas id="cv"></canvas>
<!-- Canvas SOLO para el cuadrado -->
<canvas id="ui"></canvas>

<div id="out"></div>

<script>
(() => {

/* ===== AJUSTES CLAVADOS A TU EMISOR ===== */
const UNIT_MS = 250;        // igual que en el beacon
const ROI_SIZE = 32;        // CUADRADO EXACTO (px reales)

/* ===== MORSE ===== */
const MORSE = {
".-":"A","-...":"B","-.-.":"C","-..":"D",".":"E","..-.":"F",
"--.":"G","....":"H","..":"I",".---":"J","-.-":"K",".-..":"L",
"--":"M","-.":"N","---":"O",".--.":"P","--.-":"Q",".-.":"R",
"...":"S","-":"T","..-":"U","...-":"V",".--":"W","-..-":"X",
"-.--":"Y","--..":"Z",
"-----":"0",".----":"1","..---":"2","...--":"3","....-":"4",
".....":"5","-....":"6","--...":"7","---..":"8","----.":"9"
};

/* ===== ELEMENTOS ===== */
const video = document.getElementById("video");
const cv = document.getElementById("cv");
const ui = document.getElementById("ui");
const ctxV = cv.getContext("2d",{willReadFrequently:true});
const ctxU = ui.getContext("2d");
const out = document.getElementById("out");

/* ===== CANVAS SIZE ===== */
function resize(){
  const w = innerWidth  * devicePixelRatio;
  const h = innerHeight * devicePixelRatio;
  cv.width = ui.width = w;
  cv.height = ui.height = h;
}
addEventListener("resize", resize);
resize();

/* ===== ROI (PIXELS REALES) ===== */
let roi = { x: 40, y: 40 };
let dragging=false, dx=0, dy=0;

ui.addEventListener("pointerdown", e=>{
  const x = e.clientX * devicePixelRatio;
  const y = e.clientY * devicePixelRatio;
  if (
    x >= roi.x && x <= roi.x + ROI_SIZE &&
    y >= roi.y && y <= roi.y + ROI_SIZE
  ){
    dragging = true;
    dx = x - roi.x;
    dy = y - roi.y;
    ui.setPointerCapture(e.pointerId);
  }
});

ui.addEventListener("pointermove", e=>{
  if(!dragging) return;
  roi.x = e.clientX * devicePixelRatio - dx;
  roi.y = e.clientY * devicePixelRatio - dy;
});

ui.addEventListener("pointerup", ()=>dragging=false);
ui.addEventListener("pointercancel", ()=>dragging=false);

/* ===== LUMINANCIA REAL DEL CUADRADO ===== */
function luminance(){
  ctxV.drawImage(video,0,0,cv.width,cv.height);
  const d = ctxV.getImageData(
    roi.x, roi.y, ROI_SIZE, ROI_SIZE
  ).data;

  let sum = 0;
  for(let i=0;i<d.length;i+=16){
    sum += 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
  }
  return (sum / (d.length/16)) / 255;
}

/* ===== DECODIFICADOR (1:1 CON buildQueue) ===== */
let baseline = 0;
let smooth = 0;
let lastOn = false;
let lastT = performance.now();
let current = "";
let text = "";

function flushLetter(){
  if(current){
    text += MORSE[current] ?? "�";
    out.textContent = text;
    current = "";
  }
}

function loop(){
  const lum = luminance();

  baseline += 0.02 * (lum - baseline);
  smooth   += 0.30 * (lum - smooth);

  const on = lastOn
    ? smooth > baseline + 0.03
    : smooth > baseline + 0.06;

  const now = performance.now();

  if(on !== lastOn){
    const dt = now - lastT;
    lastT = now;

    // ON → OFF : terminó punto o raya
    if(lastOn && !on){
      current += (dt < 2 * UNIT_MS) ? "." : "-";
    }

    // OFF → ON : terminó silencio
    if(!lastOn && on){
      if(dt >= 7 * UNIT_MS){
        flushLetter();
        text += " ";
        out.textContent = text;
      } else if(dt >= 3 * UNIT_MS){
        flushLetter();
      }
    }

    lastOn = on;
  }

  // dibuja SOLO el cuadrado
  ctxU.clearRect(0,0,ui.width,ui.height);
  ctxU.strokeStyle = "rgba(0,255,120,.9)";
  ctxU.lineWidth = 3 * devicePixelRatio;
  ctxU.strokeRect(roi.x, roi.y, ROI_SIZE, ROI_SIZE);

  requestAnimationFrame(loop);
}

/* ===== START ===== */
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" },
  audio:false
})
.then(stream=>{
  video.srcObject = stream;
  video.onloadedmetadata = ()=>{
    video.play();
    loop();
  };
})
.catch(()=>{
  out.textContent = "No se pudo acceder a la cámara (usa https o localhost).";
});

})();
</script>
</body>
</html>
