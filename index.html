<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Morse Decoder</title>
<style>
  body{margin:0;background:#000;overflow:hidden}
  video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover}
  canvas{
    position:fixed;
    inset:0;
    touch-action:none; /* ← CLAVE para drag en móvil */
  }
  #out{
    position:fixed;left:12px;right:12px;bottom:12px;
    padding:10px 12px;
    border:1px solid rgba(0,255,120,.8);
    border-radius:14px;
    background:rgba(0,0,0,.6);
    color:#7CFF9D;
    font:20px/1.3 system-ui;
  }
</style>
</head>
<body>

<video id="v" autoplay playsinline muted></video>
<canvas id="ui"></canvas>
<div id="out"></div>

<script>
(() => {

const UNIT = 250;
const ROI = 24; // cuadrado pequeño
const MORSE = {
".-":"A","-...":"B","-.-.":"C","-..":"D",".":"E","..-.":"F",
"--.":"G","....":"H","..":"I",".---":"J","-.-":"K",".-..":"L",
"--":"M","-.":"N","---":"O",".--.":"P","--.-":"Q",".-.":"R",
"...":"S","-":"T","..-":"U","...-":"V",".--":"W","-..-":"X",
"-.--":"Y","--..":"Z",
"-----":"0",".----":"1","..---":"2","...--":"3","....-":"4",
".....":"5","-....":"6","--...":"7","---..":"8","----.":"9"
};

const v = document.getElementById("v");
const ui = document.getElementById("ui");
const ctx = ui.getContext("2d");
const out = document.getElementById("out");

/* Canvas de lectura fuera de pantalla */
const cv = document.createElement("canvas");
const ctxV = cv.getContext("2d",{willReadFrequently:true});

function resize(){
  ui.width = cv.width = innerWidth;
  ui.height = cv.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/* ROI en CSS pixels */
let roi = { x: 80, y: 80 };
let drag=false, dx=0, dy=0;

ui.addEventListener("pointerdown", e=>{
  if(e.clientX>=roi.x && e.clientX<=roi.x+ROI &&
     e.clientY>=roi.y && e.clientY<=roi.y+ROI){
    drag=true;
    dx=e.clientX-roi.x;
    dy=e.clientY-roi.y;
    ui.setPointerCapture(e.pointerId);
  }
});
ui.addEventListener("pointermove", e=>{
  if(!drag) return;
  roi.x=e.clientX-dx;
  roi.y=e.clientY-dy;
});
ui.addEventListener("pointerup", ()=>drag=false);
ui.addEventListener("pointercancel", ()=>drag=false);

/* LEE PIXEL CENTRAL – SINCRONIZADO */
function readPixel(){
  ctxV.drawImage(v,0,0,cv.width,cv.height);
  const x = Math.floor(roi.x + ROI/2);
  const y = Math.floor(roi.y + ROI/2);
  const d = ctxV.getImageData(x,y,1,1).data;
  return 0.2126*d[0] + 0.7152*d[1] + 0.0722*d[2];
}

/* DECODER */
let lastOn=false;
let lastT=performance.now();
let ref=null;
let current="", text="";

function flush(){
  if(current){
    text+=MORSE[current]||"�";
    out.textContent=text;
    current="";
  }
}

function processFrame(){
  const lum = readPixel();
  if(ref===null) ref=lum;

  const on = lum > ref + 15; // umbral simple y robusto
  const now = performance.now();

  if(on!==lastOn){
    const dt = now-lastT;
    lastT=now;

    if(lastOn && !on){
      current += dt < 2*UNIT ? "." : "-";
    }

    if(!lastOn && on){
      if(dt >= 7*UNIT){ flush(); text+=" "; }
      else if(dt >= 3*UNIT){ flush(); }
      out.textContent=text;
    }

    lastOn=on;
    ref=lum;
  }

  ctx.clearRect(0,0,ui.width,ui.height);
  ctx.strokeStyle="rgba(0,255,120,.9)";
  ctx.lineWidth=2;
  ctx.strokeRect(roi.x,roi.y,ROI,ROI);
}

/* LOOP sincronizado al vídeo */
function startLoop(){
  if ("requestVideoFrameCallback" in HTMLVideoElement.prototype){
    const step = () => {
      processFrame();
      v.requestVideoFrameCallback(step);
    };
    v.requestVideoFrameCallback(step);
  } else {
    const step = () => {
      processFrame();
      requestAnimationFrame(step);
    };
    step();
  }
}

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false})
.then(s=>{
  v.srcObject=s;
  v.onloadedmetadata=()=>{
    v.play();
    startLoop();
  };
})
.catch(()=>out.textContent="No se pudo acceder a la cámara");

})();
</script>
</body>
</html>
