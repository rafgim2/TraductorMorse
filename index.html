<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Morse Decoder</title>
<style>
  body{margin:0;background:#000;overflow:hidden}
  video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover}
  canvas{position:fixed;inset:0;touch-action:none}
  #out{
    position:fixed;left:12px;right:12px;bottom:12px;
    padding:10px 12px;
    border:1px solid rgba(0,255,120,.8);
    border-radius:14px;
    background:rgba(0,0,0,.6);
    color:#7CFF9D;
    font:20px/1.3 system-ui;
    white-space:pre-wrap;
  }
</style>
</head>
<body>

<video id="v" autoplay playsinline muted></video>
<canvas id="ui"></canvas>
<div id="out"></div>

<script>
(() => {

const UNIT = 250;
const ROI = 24;
const PATCH = 7;
const DEBOUNCE = 0.5 * UNIT;

const MORSE = {
".-":"A","-...":"B","-.-.":"C","-..":"D",".":"E","..-.":"F",
"--.":"G","....":"H","..":"I",".---":"J","-.-":"K",".-..":"L",
"--":"M","-.":"N","---":"O",".--.":"P","--.-":"Q",".-.":"R",
"...":"S","-":"T","..-":"U","...-":"V",".--":"W","-..-":"X",
"-.--":"Y","--..":"Z",
"-----":"0",".----":"1","..---":"2","...--":"3","....-":"4",
".....":"5","-....":"6","--...":"7","---..":"8","----.":"9"
};

const v = document.getElementById("v");
const ui = document.getElementById("ui");
const ctxU = ui.getContext("2d");
const out = document.getElementById("out");

// offscreen canvas
const cv = document.createElement("canvas");
const ctxV = cv.getContext("2d",{willReadFrequently:true});

function resize(){
  ui.width = cv.width = innerWidth;
  ui.height = cv.height = innerHeight;
}
addEventListener("resize", resize);
resize();

// ROI drag
let roi={x:80,y:80}, dragging=false, dx=0, dy=0;

ui.addEventListener("pointerdown",e=>{
  if(e.clientX>=roi.x&&e.clientX<=roi.x+ROI &&
     e.clientY>=roi.y&&e.clientY<=roi.y+ROI){
    dragging=true;
    dx=e.clientX-roi.x;
    dy=e.clientY-roi.y;
    ui.setPointerCapture(e.pointerId);
  }
});
ui.addEventListener("pointermove",e=>{
  if(!dragging)return;
  roi.x=e.clientX-dx;
  roi.y=e.clientY-dy;
});
ui.addEventListener("pointerup",()=>dragging=false);
ui.addEventListener("pointercancel",()=>dragging=false);

// draw video with cover
function drawCover(){
  const W=cv.width,H=cv.height;
  const vw=v.videoWidth,vh=v.videoHeight;
  if(!vw||!vh)return false;
  const s=Math.max(W/vw,H/vh);
  const dw=vw*s, dh=vh*s;
  const dx=(W-dw)/2, dy=(H-dh)/2;
  ctxV.drawImage(v,dx,dy,dw,dh);
  return true;
}

// read patch luminance
function readLum(){
  if(!drawCover())return null;
  const cx=Math.floor(roi.x+ROI/2);
  const cy=Math.floor(roi.y+ROI/2);
  const h=Math.floor(PATCH/2);
  const data=ctxV.getImageData(cx-h,cy-h,PATCH,PATCH).data;
  let sum=0;
  for(let i=0;i<data.length;i+=4){
    sum+=0.2126*data[i]+0.7152*data[i+1]+0.0722*data[i+2];
  }
  return sum/(data.length/4);
}

// decoder
let lastStableOn=false;
let candidateOn=false;
let candidateSince=performance.now();
let lastTransition=performance.now();
let current="", text="";
let offLevel=null,onLevel=null;
let letterClosed=false, spaceAdded=false;

function flushLetter(){
  if(current){
    text+=MORSE[current]||"�";
    out.textContent=text;
    current="";
  }
}

function loop(){
  const lum=readLum();
  if(lum==null)return;

  if(offLevel==null){ offLevel=onLevel=lum; }

  const thr=(offLevel+onLevel)/2;
  const rawOn = lum > thr;

  // debounce
  if(rawOn!==candidateOn){
    candidateOn=rawOn;
    candidateSince=performance.now();
  }

  const now=performance.now();
  if(now-candidateSince>=DEBOUNCE && candidateOn!==lastStableOn){
    const dt=now-lastTransition;
    lastTransition=now;

    if(lastStableOn && !candidateOn){
      current += dt < 2*UNIT ? "." : "-";
      letterClosed=false;
      spaceAdded=false;
    }

    if(!lastStableOn && candidateOn){
      if(dt>=7*UNIT){ flushLetter(); text+=" "; spaceAdded=true; }
      else if(dt>=3*UNIT){ flushLetter(); letterClosed=true; }
      out.textContent=text;
    }

    lastStableOn=candidateOn;
  }

  // close at end (OFF without next ON)
  if(!lastStableOn){
    const offTime=now-lastTransition;
    if(offTime>=3*UNIT && current && !letterClosed){
      flushLetter();
      letterClosed=true;
    }
    if(offTime>=7*UNIT && !spaceAdded){
      text+=" ";
      out.textContent=text;
      spaceAdded=true;
    }
  }

  // adapt levels
  const a=0.05;
  if(lastStableOn) onLevel+=a*(lum-onLevel);
  else offLevel+=a*(lum-offLevel);

  // draw ROI
  ctxU.clearRect(0,0,ui.width,ui.height);
  ctxU.strokeStyle="rgba(0,255,120,.9)";
  ctxU.lineWidth=2;
  ctxU.strokeRect(roi.x,roi.y,ROI,ROI);
}

function start(){
  if("requestVideoFrameCallback"in HTMLVideoElement.prototype){
    const step=()=>{loop();v.requestVideoFrameCallback(step);};
    v.requestVideoFrameCallback(step);
  }else{
    const step=()=>{loop();requestAnimationFrame(step);};
    step();
  }
}

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false})
.then(s=>{
  v.srcObject=s;
  v.onloadedmetadata=()=>{v.play();start();};
})
.catch(()=>out.textContent="No se pudo acceder a la cámara");

})();
</script>
</body>
</html>
